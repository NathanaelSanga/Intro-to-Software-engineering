{% extends "base.html" %}
{% block content %}
<div class="cart-container">
    <div class="cart-title">Your Cart</div>
    {% if cart_items %}
        <table class="cart-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>
                        {% if item.product.image_path %}
                        <img src="{{ url_for('static', filename='uploads/' + item.product.image_path) }}" class="cart-item-img" alt="{{ item.product.name }}">
                        {% endif %}
                        <span class="product-title">{{ item.product.name }}</span>
                    </td>
                    <td>{{ item.product.quantity }} {{ item.product.unit }} * {{ '{:,.2f}'.format(item.product.price) }} birr</td>
                    <td>{{ '{:,.2f}'.format(item.product.quantity * item.product.price) }} birr</td>
                    <td>
                        <form method="POST" action="{{ url_for('cart.remove_from_cart', product_id=item.product.id) }}" style="display:inline;">
                            <button type="submit" class="remove-btn">Remove</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% set ns = namespace(total_price=0, unit_totals={}) %}
        {% for item in cart_items %}
            {% set ns.total_price = ns.total_price + (item.product.quantity * item.product.price) %}
            {% set unit = item.product.unit %}
            {% if unit in ns.unit_totals %}
                {% set ns.unit_totals = ns.unit_totals.update({unit: ns.unit_totals[unit] + item.product.quantity}) or ns.unit_totals %}
            {% else %}
                {% set ns.unit_totals = ns.unit_totals.update({unit: item.product.quantity}) or ns.unit_totals %}
            {% endif %}
        {% endfor %}
        <div class="cart-summary" style="margin-top:20px; font-weight:bold;">
            Total: {{ '{:,.2f}'.format(ns.total_price) }} birr<br>
            Total Units:
            {%- for unit, qty in ns.unit_totals.items() %}
                {{ qty }} {{ unit }}{% if not loop.last %}, {% endif %}
            {%- endfor %}
        </div>
        <form method="POST" action="{{ url_for('cart.purchase') }}" style="margin-top: 24px; text-align: right;">
            <button type="submit" class="btn btn-success" style="font-size:1.1em; padding: 10px 32px; border-radius: 8px; font-weight:600;">Purchase</button>
        </form>
    {% else %}
        <div class="empty-cart-message">Your cart is empty.</div>
    {% endif %}
</div>
{% endblock %}