{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Register</h3>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form action="{{ url_for('register.register_authentication') }}" method="POST" enctype="multipart/form-data" id="registerForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required value="{{ form_data.username if form_data else '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required value="{{ form_data.email if form_data else '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">I am a:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="userRole" id="farmerRole" value="Farmer" required {% if form_data and form_data.role == 'Farmer' %}checked{% endif %}>
                                <label class="form-check-label" for="farmerRole">
                                    Farmer
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="userRole" id="buyerRole" value="Customer" required {% if form_data and form_data.role == 'Customer' %}checked{% endif %}>
                                <label class="form-check-label" for="buyerRole">
                                    Buyer
                                </label>
                            </div>
                        </div>

                        <div id="farmerFields" style="display: none;">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" value="{{ form_data.phone if form_data else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" value="{{ form_data.city if form_data else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="subCity" class="form-label">Sub City</label>
                                <input type="text" class="form-control" id="subCity" name="subCity" value="{{ form_data.subcity if form_data else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="idPicture" class="form-label">ID Picture</label>
                                <input type="file" class="form-control" id="idPicture" name="idPicture" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label for="facePicture" class="form-label">Face Picture</label>
                                <input type="file" class="form-control" id="facePicture" name="facePicture" accept="image/*">
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Sign Up</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const farmerFields = document.getElementById('farmerFields');
    const farmerRole = document.getElementById('farmerRole');
    const buyerRole = document.getElementById('buyerRole');
    const form = document.getElementById('registerForm');

    // Function to toggle farmer fields
    function toggleFarmerFields() {
        const isFarmer = farmerRole.checked;
        farmerFields.style.display = isFarmer ? 'block' : 'none';
        
        // Set required attributes for farmer fields
        const farmerInputs = farmerFields.querySelectorAll('input');
        farmerInputs.forEach(input => {
            if (input.type !== 'file') {
                input.required = isFarmer;
            }
        });
    }

    // Initial check for role selection
    if (farmerRole.checked) {
        toggleFarmerFields();
    }

    // Add event listeners for role selection
    farmerRole.addEventListener('change', toggleFarmerFields);
    buyerRole.addEventListener('change', toggleFarmerFields);

    // Form submission validation
    form.addEventListener('submit', function(e) {
        const selectedRole = document.querySelector('input[name="userRole"]:checked');
        
        if (!selectedRole) {
            e.preventDefault();
            alert('Please select whether you are a Farmer or Buyer');
            return;
        }

        if (selectedRole.value === 'Farmer') {
            const farmerInputs = farmerFields.querySelectorAll('input[required]');
            let isValid = true;
            
            farmerInputs.forEach(input => {
                if (!input.value) {
                    isValid = false;
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required farmer information');
                return;
            }

            const idPicture = document.getElementById('idPicture');
            const facePicture = document.getElementById('facePicture');
            
            if (!idPicture.files.length || !facePicture.files.length) {
                e.preventDefault();
                alert('Please upload both ID and face pictures');
                return;
            }
        }
    });
});
</script>
{% endblock %}
